language: ruby

addons:
  snaps:
  - name: google-cloud-sdk
    confinement: classic

services:
- docker

branches:
  only:
    - master

env:
  USE_GIT_MTIMES: true

jobs:
  include:
    - name: build and deploy
      before_script:
        - rm .gitignore
        - git add _site
        - git commit -am 'add _site'
        - export IMG_TAG=$(git rev-parse --short HEAD)
        - echo $GCP_SA_KEY > /tmp/gcp_sa_key.json
        - gcloud -q auth activate-service-account --key-file /tmp/gcp_sa_key.json && gcloud auth configure-docker;
        - docker build . --cache-from gcr.io/travis-ci-prod-services-1/speedtest-pub:latest -t gcr.io/travis-ci-prod-services-1/speedtest-pub:$IMG_TAG
        - docker tag gcr.io/travis-ci-prod-services-1/speedtest-pub:$IMG_TAG gcr.io/travis-ci-prod-services-1/speedtest-pub:latest
      script:
        - docker push gcr.io/travis-ci-prod-services-1/speedtest-pub:$IMG_TAG
        - docker push gcr.io/travis-ci-prod-services-1/speedtest-pub:latest
